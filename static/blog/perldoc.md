2014-04-06 追記　新しいバージョンでは挙動が変わったみたいなので、最後に追記しました。


最近の`perldoc`コマンドは、インストールされている`groff`が古いと、以下の様な警告メッセージを出します。

    You have an old groff. Update to version 1.20.1 for good Unicode support.
    If you don't upgrade, wide characters may come out oddly.

perldocから、内部的にシステムにインストールされているgroffが呼び出されるのですが、それが古いって言ってますね。

普段`perldoc`で日本語で書かれたドキュメントを読むことは無いのであまり気にしていませんでしたが、拙作の[`Enbld`](https://metacpan.org/pod/Enbld)というツールの日本語ドキュメントをpodで書いたので、perldocを使って日本語で書かれたドキュメントを読む方法を調べてみました。

以下、OS X 10.9 + perl 5.18.2環境で検証しました。

### groffをインストールする
OS Xの`groff`は、いくらOSのバージョンが上がっても頑なに2004年にリリースされた1.19.2というバージョンが使われ続けています。

おそらくGPLの関係だと思われるので、とっとと自分でインストールします。

`Enbld`で最新版をインストールします。

    $ enblder install groff

	$ groff -v
	GNU groff version 1.22.2
	Copyright (C) 2013 Free Software Foundation, Inc.
	GNU groff comes with ABSOLUTELY NO WARRANTY.
	You may redistribute copies of groff and its subprograms
	under the terms of the GNU General Public License.
	For more information about these matters, see the file named COPYING.
		
	called subprograms:
		
	GNU grops (groff) version 1.22.2
	GNU troff (groff) version 1.22.2

最新版のgroff 1.22.2がインストールされました。

### 日本語のpodを用意する

早速、インストールしたgroffを使っていきましょう。

まずは、utf-8で書かれたpodを用意します。

    =pod

    =encoding utf8

    =head1 見出し

    これは本文です。

    =cut

`pod`では文字コードにLatain-1以外を使う時は、必ずencodingに文字コードをを指定します。

`pod.pod`という名前で保存します。

### perldocを使って表示する

`perldoc`を使って表示します。

    $ perldoc pod.pod

    POD(1)                User Contributed Perl Documentation               POD(1)



    XXX
           XX



    perl v5.18.2                      2014-04-05                            POD(1)

はい、全然ダメですね。

原因を探っていきます。

### perldocの内部構造

`perldoc`コマンドも、perlで書かれたスクリプトになっています。

    $ more perldoc
    - 省略 -

    # This "perldoc" file was generated by "perldoc.PL"

    require 5;
    BEGIN { $^W = 1 if $ENV{'PERLDOCDEBUG'} }
    use Pod::Perldoc;
    exit( Pod::Perldoc->run() );

使っているのは`Pod::Perldoc`というコアモジュールです。

`Pod::Perldoc`の1346行目に有る以下のコードが実際に、podファイルを読み込んでいる箇所です。

    eval {  $formatter->parse_from_file( $file, $out_fh )  };

`$formatter`の中には、`Pod::Perldoc::ToMan`のオブジェクトが入っていて、`parse_from_file`メソッドを呼び出すことで、受け取ったファイルをターミナルに表示します。

(`$formatter`を特定するロジックが、えらーーーーく複雑なので、ここでは割愛します…特にオプションを付けないと、普通のUNIX系の環境では`Pod::Perldoc::ToMan`が選択されます。）

更に追いかけて行くと、`parse_from_file`メソッドから`_parse_with_pod_man`メソッドが呼ばれています。

この`_parse_with_pod_man`メソッドから、`Pod::Perldoc::ToMan`モジュールを呼び出しています。

#### Pod::Manモジュール

`Pod::Perldoc::ToMan`モジュールを追いかけて行くと、161行目に`Pod::Man`モジュールを呼び出しているところが有ります。

    my $parser = Pod::Man->new( $self->_get_podman_switches );

**この`Pod::Man`モジュールのコンストラクタへの引数がポイントです!!**

`Pod::Man`モジュールのpodを確認してみましょう。

	   The recognized options to new() are as follows.  All options take a
       single argument.

    - 省略 -

    utf8
           By default, Pod::Man produces the most conservative possible *roff
           output to try to ensure that it will work with as many different
           *roff implementations as possible.  Many *roff implementations
           cannot handle non-ASCII characters, so this means all non-ASCII
           characters are converted either to a *roff escape sequence that
           tries to create a properly accented character (at least for troff
           output) or to "X".

		   If this option is set, Pod::Man will instead output UTF-8.  If your
           *roff implementation can handle it, this is the best output format
           to use and avoids corruption of documents containing non-ASCII
           characters.  However, be warned that *roff source with literal
           UTF-8 characters is not supported by many implementations and may
           even result in segfaults and other bad behavior.

デフォルトでは、ASCII以外の文字列は、"X"になっちゃうよって書かれていますね。この引数が真になるようにセットしないといくらutf-8でpodを書いても意味ないって事です。

#### Pod::Manモジュールへの引数

では、`Pod::Perldoc::ToMan`は、この引数を確認してみましょう。

答えは、`_get_podman_switches`メソッドの中に有ります。

       my @switches = grep !m/^_/s, keys %$self;

    # There needs to be a cleaner way to handle setting
    # the UTF-8 flag, but for now, comment out this
    # line because it often does the wrong thing.
    #   
    # See RT #77465
    #   
    #push @switches, 'utf8' => 1;

    $self->debug( "Pod::Man switches are [@switches]\n" );

    return @switches;

見事に、utf8フラグをセットする箇所がコメントアウトされています…。

と言うわけで、現状の`perldoc`はそのままでは日本語が表示されません。

## 解決策

`perldoc`には、`-t`オプションが有り、このオプションを使うと、`Pod::Man`モジュールではなく、`Pod::Text`モジュールを使います。

`Pod::Text`の`perldoc`を見てみましょう。

    new() can take options, in the form of key/value pairs, that control
    the behavior of the parser.  The currently recognized options are:

       utf8
           By default, Pod::Text uses the same output encoding as the input
           encoding of the POD source (provided that Perl was built with
           PerlIO; otherwise, it doesn't encode its output).  If this option
           is given, the output encoding is forced to UTF-8.

`Pod::Text`モジュールは、ちゃんとpodのエンコーディングを参照してくれることが分かりますね。

実際に起動してみましょう。

    $ perldoc -t pod.pod
	見出し
         本文

ちゃんと表示されました。

と言うわけで、日本語のpodを参照する時は、-tオプションを使いましょう、ということでした。

groffをインストールした意味が全然無かったですね…。

2014-04-06 追記

GitHubのリポジトリを追いかけてみると、最近リリースされたPod::Perldocの3.20からは挙動が変わり、Pod::Manではなく、Pod::Text::Termcapを使う様に変わっています。

おそらく Perl 5.20からはコアに入ると思われますので、今後はperldocコマンドでも普通に日本語のpodが扱える様になります。

でもやっぱりgroffのインストールは無駄でしたね…。

日本語でpodが読みたい人は、すぐにPod::Perldocをバージョンアップしましょう。

